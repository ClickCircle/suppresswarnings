<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>收银台-素朴网联</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
  <link rel="stylesheet" href="css/suppresswarnings.css">

  <script type="text/javascript" src="js/jweixin-1.2.0.js"></script>

  <style type="text/css">
      pre{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;}
  </style>
</head>
<body>

<div id="popWindow" class="popWindow" style="text-align:center;display: none;background-color:#9D9D9D;width: 100%;height: 100%;left: 0;top: 0;filter: alpha(opacity=30);opacity: 0.3;z-index: 100;position: absolute;">
    <div style="margin-top:30%;background:url(/loading.gif) no-repeat;"></div>
</div>

<div class="container-fluid">
<ul style="list-style: none; padding: 20px 0px 20px;">
<li style="list-style: none; float: left;">
  <span>
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" height=20 width=100>
        <path id="svg_ul" d="M4 2 L4 6"     style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_u"  d="M10 2 L10 6"   style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_ur" d="M16 2 L16 6"   style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_ml" d="M4 8 L4 12"    style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_mr" d="M16 8 L16 12"  style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_dl" d="M4 14 L4 18"   style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_d"  d="M10 14 L10 18" style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_dr" d="M16 14 L16 18" style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <text x="25" y="17" fill="#5cb85c" id="inviteTitle">素朴网联</text>
        </svg>
 </span>
 </li>
 <li style="list-style: none; float: right">
     <span><img id="userimg" alt="图" style="width: 20px;height: 20px;" src="/black-logo.jpg"><a href="/user.html">用户中心</a></span>
 </li>
 </ul>
</div>

 
<div class="modal fade" id="sampleModal" tabindex="-1" role="dialog" aria-labelledby="sampleModalLabel">
    <div class="modal-dialog text-center" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="sampleModalLabel" >支付成功</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <div class="description" id="sampleData"></div>
                    </div>
                   
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid" style="background: white;margin-bottom: 88px;" id="main">

<ul id="business" style="list-style: none; position: relative; margin: 20px 0;padding: 0;">

  <li>
  <div class="form-group">描述：<span id="reason"></span></div>
  <div class="form-group">商品：<span id="what"></span></div>
  <div id="crewimg" class="form-group text-center"></div>
    <table style="text-align: center; width: 110%; margin: 0 -5% 0;">
      <tbody>
      	<tr>
          <td style="border-bottom: 1px solid #5cb85c;">
          	<input id="amount" type="text" oninput="changeval(this)" class="btn" name="amount" value="100"/>
          </td>
        </tr>
        <tr>
          <td>
          	<button id="btnbuy" type="button" class="btn btn-ms btn-success" style="margin:20px 0 10px;" onclick="pay()">确认支付 ¥<span id="money">1.00</span></button>
          </td>
        </tr>
      </tbody>
    </table>
    
    <button id="btnmore" type="button" class="btn btn-xs" onclick="more()">更多商品</button>
    <div id="moregoods" style="display:none">
    <p><a href="http://suppresswarnings.com/payment.html?state=DaigouAgent">申请代购Agent权限</a></p>
    <p><a href="http://suppresswarnings.com/payment.html?state=Reply">申请回答问题权限</a></p>
    <p><a href="http://suppresswarnings.com/payment.html?state=Similar">申请回答同义句权限</a></p>
    </div>
</li>
</ul>


</div>
   
   
   
   
   <footer class="footer navbar-fixed-bottom" style="z-index:-1">
     <div style="text-align:center;width:100%;margin:0 auto; padding:20px 0;">
     <a href='mailto:email@suppresswarnings.com'>email@suppresswarnings.com</a><br/>
     <span>珠海市横琴新区宝华路6号105室</span><br/>
       <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44049102496289" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;">
         <img src="beian.png" class="icon" style="float:left;"/>
         <p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">
                                   粤公网安备 44049102496289号
         </p>
       </a>
     </div>
   </footer>

<!-- JavaScript Includes -->
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/transition.js"></script>
<script type="text/javascript" src="js/dropdown.js"></script>
<script type="text/javascript" src="js/collapse.js"></script>
<script type="text/javascript" src="js/suppresswarnings.js"></script>
<script>
var bridgeReady = 0

showDiv()

function more(){
	$("#moregoods").toggle()
}

function GetRequest() {
    var url = location.search; //获取url中"?"符后的字串
    var theRequest = new Object();
    if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        strs = str.split("&");
        for(var i = 0; i < strs.length; i ++) {
            theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
        }
    }
    return theRequest;
}


function pay() {
  if(bridgeReady == 1) {
	  console.log("lijiaming: bridgeReady = 1")
    $.ajax({
    url: "/wx.http?r=" + Math.random(),
    data: {
	    action : "prepay",
	    random : randnum,
	    ticket : ticket,
	    goodsid: state,
	    amount : $("#amount").val()
    },
    success: function( result ) {
      console.log('pay ok' + result)
      
      var prepay = JSON.parse(result)
      
      console.log('prepay.package = ' + prepay.package)
      WeixinJSBridge.invoke(
            'getBrandWCPayRequest', {
               "appId": prepay.appId,
               "timeStamp":prepay.timeStamp,
               "nonceStr":prepay.nonceStr,
               "package":prepay.package,
               "signType":prepay.signType,
               "paySign":prepay.paySign
            },
            function(res){
              console.log('res.err_msg'+res.err_msg)
              if(res.err_msg == "get_brand_wcpay_request:ok" ){
                  console.log('finish success')
                  var smodal = $('#sampleModal')
				  $("#sampleData").html("恭喜，您已经支付成功！")
				  smodal.modal('show')
            }
      });

    },
    error: function( xhr, result, obj ) {
      console.log("prepay err: " + obj )
    }
  })
  } else {
    $("#btnbuy").text("暂时无法支付")
  }
}

function onBridgeOK(){
  bridgeReady = 1
  showDiv()
}

function changeval(obj) {
	var val = $(obj).val()
	val = val.replace(/[^\d]/g,'')
	if(val.length < 1) val = "1"
	$(obj).val(val)
	var price = 0.01 * parseFloat(val)
	price = price.toFixed(2)
	$("#money").text(price)
}

function onBridgeReady(state){
	console.log('ready onBridgeReady')
	window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx41b262e9b9d8885e&redirect_uri=http://suppresswarnings.com/payment.html&response_type=code&scope=snsapi_base&state="+state+"#wechat_redirect"
}

if (typeof WeixinJSBridge == "undefined"){
	if( document.addEventListener ){
	    document.addEventListener('WeixinJSBridgeReady', onBridgeOK, false);
	} else if (document.attachEvent){
	    document.attachEvent('WeixinJSBridgeReady', onBridgeOK); 
	    document.attachEvent('onWeixinJSBridgeReady', onBridgeOK);
	}
}

var Request = GetRequest();
if(Request.state === undefined) {
	state = "Data0001"
	console.log("lijiaming: use default state=payment")
} else {
	state = Request.state
	console.log("lijiaming: use state=" + state)
}

if(Request.code === undefined) {
	console.log("lijiaming: no code")
	onBridgeReady(state)
} else {
	ticket = Request.code
	state  = Request.state
	console.log("code: " + ticket + ", state: " + state)
	jQuery.getScript("js/payment.js?r=" + Math.random());
	var input = $("#amount")
	if(state.indexOf("Data") != -1) {
		input.show()
		input.focus()
	} else {
		input.hide()
	}
	closeDiv()
}



</script>
</body>
</html>