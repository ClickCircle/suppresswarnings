<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>收银台-素朴网联</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
  <link rel="stylesheet" href="css/suppresswarnings.css">

  <script type="text/javascript" src="js/jweixin-1.2.0.js"></script>

  <style type="text/css">
      pre{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;}
  </style>
</head>
<body>

<div id="popWindow" class="popWindow" style="text-align:center;display: none;background-color:#9D9D9D;width: 100%;height: 100%;left: 0;top: 0;filter: alpha(opacity=30);opacity: 0.3;z-index: 100;position: absolute;">
    <div style="margin-top:30%;background:url(/loading.gif) no-repeat;"></div>
</div>

<div class="container-fluid">
<ul style="list-style: none; padding: 20px 0px 20px;">
<li style="list-style: none; float: left;">
  <span>
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" height=20 width=100>
        <path id="svg_ul" d="M4 2 L4 6"     style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_u"  d="M10 2 L10 6"   style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_ur" d="M16 2 L16 6"   style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_ml" d="M4 8 L4 12"    style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_mr" d="M16 8 L16 12"  style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_dl" d="M4 14 L4 18"   style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_d"  d="M10 14 L10 18" style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <path id="svg_dr" d="M16 14 L16 18" style="fill:white;stroke:#5cb85c;stroke-width:4"/>
        <text x="25" y="17" fill="#5cb85c" id="inviteTitle">素朴网联</text>
        </svg>
 </span>
 </li>
 <li style="list-style: none; float: right">
     <span><img id="userimg" alt="图" style="width: 20px;height: 20px;" src="/black-logo.jpg"><a href="/user.html">用户中心</a></span>
 </li>
 </ul>
</div>

 
<div class="modal fade" id="sampleModal" tabindex="-1" role="dialog" aria-labelledby="sampleModalLabel">
    <div class="modal-dialog text-center" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="sampleModalLabel" >支付成功</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <div class="description" id="sampleData"></div>
                    </div>
                   
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid" style="background: white;margin-bottom: 88px;" id="main">

<ul id="business" style="list-style: none; position: relative; margin: 20px 0;padding: 0;">

  <li>
  <div class="form-group">描述：<span id="reason"></span></div>
  <div class="form-group">商品：<span id="what"></span></div>
  <div id="crewimg" class="form-group text-center"></div>
    <table style="text-align: center; width: 100%; margin: 0 0 0;">
      <tbody>
      	<tr>
          <td style="border-bottom: 1px solid #5cb85c;">
          	<input id="amount" readonly="readonly" unselectable="on" onfocus="this.blur()" type="text" onchange="changeval(this)" class="btn" name="amount" value="" autofocus="autofocus"/>
          </td>
        </tr>
        <tr>
          <td>
          	<button id="btnbuy" type="button" class="btn btn-ms btn-success" style="margin:20px 0 10px;" onclick="pay()"><span id="info">确认支付</span> ¥<span id="money">1.00</span></button>
          </td>
        </tr>
      </tbody>
    </table>
    
    <button id="btnmore" type="button" class="btn btn-xs" onclick="more()">更多商品</button>
    <div id="moregoods" style="display:none; margin:20px;">
    <p><span style="width:100%;border:1px dotted #ccc;">开通权限</span></p>
    <p><a href="http://suppresswarnings.com/payment.html?state=Shop">申请我的商铺权限</a></p>
    <p><a href="http://suppresswarnings.com/payment.html?state=DaigouAgent">申请代购Agent权限</a></p>
    <p><a href="http://suppresswarnings.com/payment.html?state=Reply">申请回答问题权限</a></p>
    <p><a href="http://suppresswarnings.com/payment.html?state=Similar">申请回答同义句权限</a></p>
    
    <p><span style="width:100%;border:1px dotted #ccc;">购买数据</span></p>
    <p><a href="http://suppresswarnings.com/payment.html?state=Data0001">购买散装数据</a></p>
    
    <p><span style="width:100%;border:1px dotted #ccc;">商铺支付</span></p>
    <p><a href="http://suppresswarnings.com/payment.html?state=Money">面对面支付</a></p>
    </div>
</li>
</ul>


</div>
   
<!-- JavaScript Includes -->
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/transition.js"></script>
<script type="text/javascript" src="js/dropdown.js"></script>
<script type="text/javascript" src="js/collapse.js"></script>
<script type="text/javascript" src="js/suppresswarnings.js"></script>
<script>
var bridgeReady = 0
var rate = 1
showDiv()

function more(){
	$("#moregoods").toggle()
}

function GetRequest() {
    var url = location.search; //获取url中"?"符后的字串
    var theRequest = new Object();
    if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        strs = str.split("&");
        for(var i = 0; i < strs.length; i ++) {
            theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
        }
    }
    return theRequest;
}


function pay() {
  if(bridgeReady == 1) {
	  console.log("lijiaming: bridgeReady = 1")
    $.ajax({
    url: "/wx.http?r=" + Math.random(),
    data: {
	    action : "prepay",
	    random : randnum,
	    ticket : ticket,
	    goodsid: state,
	    amount : $("#amount").val()
    },
    success: function( result ) {
      console.log('pay ok' + result)
      
      var prepay = JSON.parse(result)
      
      console.log('prepay.package = ' + prepay.package)
      WeixinJSBridge.invoke(
            'getBrandWCPayRequest', {
               "appId": prepay.appId,
               "timeStamp":prepay.timeStamp,
               "nonceStr":prepay.nonceStr,
               "package":prepay.package,
               "signType":prepay.signType,
               "paySign":prepay.paySign
            },
            function(res){
              console.log('res.err_msg'+res.err_msg)
              if(res.err_msg == "get_brand_wcpay_request:ok" ){
                  console.log('finish success')
				  $("#sampleData").html("恭喜，您已经支付成功！")
				  wx.closeWindow();
            }
      });

    },
    error: function( xhr, result, obj ) {
      console.log("prepay err: " + obj )
    }
  })
  } else {
    $("#btnbuy").text("暂时无法支付")
  }
}

function onBridgeOK(){
  bridgeReady = 1
}

function changeval(obj) {
	var val = $(obj).val()
	val = val.replace(/[^\d.]/g,'')
	if(val.length < 1) {
	    val = ""
            $("#info").text("请输入数字")
            $("#money").text("0.00")
        } else {
	    $(obj).val(val)
	    var price = 0.01 * parseFloat(val) * rate
	    price = price.toFixed(2)
	    $("#info").text("确认支付")
        $("#money").text(price)
	}
}

(function(exports) {
  var KeyBoard = function(input,n,options) {
    var body = document.getElementsByTagName('body')[0];
    var DIV_ID = options && options.divId || '__w_l_h_v_c_z_e_r_o_divid';
    if (document.getElementById(DIV_ID)) {
      body.removeChild(document.getElementById(DIV_ID));
    }
    this.input = input;
    this.el = document.createElement('div');
    var self = this;
    var zIndex = options && options.zIndex || 1000;
    var width = options && options.width || '100%';
    var height = options && options.height || '200px';
    var paddingTop = options && options.paddingTop || '5px';
    var paddingBottom = options && options.paddingBottom || '5px';
    var fontSize = options && options.fontSize || '15px';
    var border = options && options.borderTop || 'solid 1px #ccc;';
    var backgroundColor = options && options.backgroundColor || '#dddddd';
    var TABLE_ID = options && options.table_id || 'table_0909099';
    var mobile = typeof orientation !== 'undefined';
    this.el.id = DIV_ID;
    this.el.style.position = 'fixed';
    this.el.style.left = 0;
    this.el.style.right = 0;
    //this.el.style.bottom = 0;
    this.el.style.zIndex = zIndex;
    this.el.style.width = width;
    this.el.style.height = height;
    this.el.style.borderTop = border;
    this.el.style.backgroundColor = backgroundColor;
    //样式
    var cssStr = '<style type="text/css">';
    // 用css控制键盘是否显示
    cssStr += '.nfs-keyboard-header{height:50px;background-color:#eee;font-size: 18px;color: #888;}';
    cssStr += '.nfs-keyboard-body{height:200px;background-color:#eee;}';
    cssStr += '.opacityOut{display:none}';
    cssStr += '.a-bounceinB{bottom:0;border:0;-webkit-animation:bounceinB 0.3s ease-in backwards;-moz-animation:bounceinB 0.3s ease-in backwards;-ms-animation:bounceinB 0.3s ease-in backwards;animation:bounceinB 0.3s ease-in backwards;}';
    cssStr += '.a-bounceoutB{bottom:-250px;border:0;padding:0;-webkit-animation:bounceoutB 0.3s ease-out backwards;-moz-animation:bounceoutB 0.3s ease-out backwards;-ms-animation:bounceoutB 0.3s ease-out backwards;animation:bounceoutB 0.3s ease-out backwards;}';
    cssStr += '@-webkit-keyframes bounceoutB{0%{opacity:1;-webkit-transform:translateY(-250px);}100%{opacity:0;-webkit-transform:translateY(0);}}';
    cssStr += '@-moz-keyframes bounceoutB{0%{opacity:1;-webkit-transform:translateY(-250px);}100%{opacity:0;-webkit-transform:translateY(0);}}';
    cssStr += '@-ms-keyframes bounceoutB{0%{opacity:1;-webkit-transform:translateY(-250px);}100%{opacity:0;-webkit-transform:translateY(0);}}';
    cssStr += '@keyframes bounceoutB{0%{opacity:1;-webkit-transform:translateY(-250px);}100%{opacity:0;-webkit-transform:translateY(0);}}';
    cssStr += '@-webkit-keyframes bounceinB{0%{opacity:0;-webkit-transform:translateY(250px);}100%{opacity:1;-webkit-transform:translateY(0);}}';
    cssStr += '@-moz-keyframes bounceinB{0%{opacity:0;-webkit-transform:translateY(250px);}100%{opacity:1;-webkit-transform:translateY(0);}}';
    cssStr += '@-ms-keyframes bounceinB{0%{opacity:0;-webkit-transform:translateY(250px);}100%{opacity:1;-webkit-transform:translateY(0);}}';
    cssStr += '@keyframes bounceinB{0%{opacity:0;-webkit-transform:translateY(250px);}100%{opacity:1;-webkit-transform:translateY(0);}}';
    //table样式
    cssStr += '#' + TABLE_ID + '{font-size:18px;text-align:center;width:100%;height:200px;border-top:1px solid #CECDCE;background-color:#FFF;}';
    cssStr += '#' + TABLE_ID + ' td{width:33%;border:1px solid #ddd;border-right:0;border-top:0;}';
    if (!mobile) {
      cssStr += '#' + TABLE_ID + ' td:hover{background-color:#1FB9FF;color:#FFF;}';
    }
    cssStr += '</style>';
    //background
    var back = '<div id="background" style="position: fixed;z-index:-1001;top: 0;right: 0;bottom: 0;left: 0;background-color: rgba(0,0,0,.3);font-size:0;">123</div>'
    //nfs-keyboard-header
    var header = '<div class="nfs-keyboard-header">';
    //Button
    var btnCompleteStr = '<div style="width:15%;height:32px;background-color:#1FB9FF;';
    btnCompleteStr += 'float:right;margin-right:2%;text-align:center;color:#fff;';
    btnCompleteStr += 'line-height:32px;font-size: 14px;border-radius:3px;margin-top:8px;;cursor:pointer;">完成</div>';
    //Button
    var btnCancelStr = '<div style="width:15%;height:32px;background-color:#D3D9DF;';
    btnCancelStr += 'float:left;margin-left:2%;text-align:center;color:#000;';
    btnCancelStr += 'line-height:32px;font-size: 14px;border-radius:3px;margin-top:8px;cursor:pointer;">取消</div>';
    //input
    var inputStr = '<input type="text" id="_input" value="" readonly="readonly" placeholder="" unselectable="on" onfocus="this.blur()"';
    inputStr += ' style="width:50%;height:28px;float:left;margin-left:8%;';
    inputStr += 'text-align:right;color:#000;border: 1px solid #ccc;';
    inputStr += 'line-height:28px;margin-top:10px;font-size:18px;"><div style="clear:both"></div></div>';
    //nfs-keyboard-body
    //table
    var tableStr = '<div class="nfs-keyboard-body">';
    tableStr += ' <table id="' + TABLE_ID + '" border="0" cellspacing="0" cellpadding="0">';
    tableStr += '   <tr><td>1</td><td>2</td><td>3</td></tr>';
    tableStr += '   <tr><td>4</td><td>5</td><td>6</td></tr>';
    tableStr += '   <tr><td>7</td><td>8</td><td>9</td></tr>';
    tableStr += '   <tr><td style="background-color:#D3D9DF;">.</td><td>0</td>';
    tableStr += '       <td style="background-color:#D3D9DF;">删除</td></tr>';
    tableStr += '</table>';
    tableStr += '</div>';
    //html的渲染
    this.el.innerHTML = cssStr + header + tableStr;
    
    //控制输入框中的格式
    function clearNoNum(obj) {
      obj.value = obj.value.replace(/[^\d.]/g, ""); //清除“数字”和“.”以外的字符
      obj.value = obj.value.replace(/^\./g, ""); //验证第一个字符是数字而不是.
      obj.value = obj.value.replace(/\.{2,}/g, "."); //只保留第一个. 清除多余的.
      obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
      if(obj.value.indexOf(".") < 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value); 
        }
      if(obj.value.indexOf(".") >= 0){//判断是否有小数点
        if(obj.value.split(".")[1].length > n){//控制只能输入小数点后2位
          obj.value = obj.value.substr(0, obj.value.length - 1);
        }
      }
    }
  
    function addEvent(e) {
      var ev = e || window.event;
      var clickEl = ev.element || ev.target;
      var value = clickEl.textContent || clickEl.innerText;
      if (clickEl.tagName.toLocaleLowerCase() === 'td' && value !== "删除") {
        if (input) {
          if (clickEl.tagName.toLocaleLowerCase() === 'td' && value === ".") {
            if(n <= 0){
              input.value = input.value;
            }else{
              input.value += value;
              clearNoNum(input);
            }
          }else{
            input.value += value;
            clearNoNum(input);
          }
        }
      } else if (clickEl.tagName.toLocaleLowerCase() === 'td' && value === "删除") {
        var num = input.value;
        if (num) {
          var newNum = num.substr(0, num.length - 1);
          input.value = newNum;
        }
      }
      changeval(input)
    }
    
    if (mobile) {
      this.el.ontouchstart = addEvent;
    } else {
      this.el.onclick = addEvent;
    }
    body.appendChild(this.el);
    this.el.classList = 'a-bounceinB';
  }
  exports.KeyBoard = KeyBoard;
})(window);

function onBridgeReady(state){
	console.log('ready onBridgeReady')
	window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx41b262e9b9d8885e&redirect_uri=http://suppresswarnings.com/payment.html&response_type=code&scope=snsapi_base&state="+state+"#wechat_redirect"
}

if (typeof WeixinJSBridge == "undefined"){
	if( document.addEventListener ){
	    document.addEventListener('WeixinJSBridgeReady', onBridgeOK, false);
	} else if (document.attachEvent){
	    document.attachEvent('WeixinJSBridgeReady', onBridgeOK); 
	    document.attachEvent('onWeixinJSBridgeReady', onBridgeOK);
	}
}

var Request = GetRequest();
if(Request.state === undefined) {
	state = "Data0001"
	console.log("lijiaming: use default state=payment")
} else {
	state = Request.state
	console.log("lijiaming: use state=" + state)
}

if(Request.code === undefined) {
	console.log("lijiaming: no code")
	onBridgeReady(state)
} else {
	ticket = Request.code
	state  = Request.state
	showDiv()
	console.log("code: " + ticket + ", state: " + state)
	var url = window.location.href;
		var en = base64encode(url);
		console.log("====== ======= " + en);
		$.ajax({
			type: 'GET',
			url: '/wx.http?action=jsapi_ticket&url='+en,
			dataType: 'json',
			success: function(data) {
				wx.config({
				    debug: false,
				    appId: 'wx41b262e9b9d8885e',
				    timestamp: data.timestamp,
				    nonceStr: data.nonceStr,
				    signature: data.signature,
				    jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'closeWindow']
				});
			
				wx.ready(function () {
				    console.log(window.__wxjs_environment === 'miniprogram');
					wx.checkJsApi({
					    jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'closeWindow'],
					    success: function(res) {
					        console.log("check js api ok: " + res)
					    }
					});
				    wx.onMenuShareTimeline({ 
				        title: '进来点赞就可以赚钱',
				        link: 'http://suppresswarnings.com/like.html',
				        imgUrl: 'http://suppresswarnings.com/like.png',
				        success: function () {
				           console.log("===== lijiaming ====");
				        }
				    });
				    
				    wx.onMenuShareAppMessage({
						title: '进来点赞就可以赚钱',
						desc: '进来点赞评论就可以赚钱，分享给朋友圈，还可以额外获得分红提成，分红100%可以提现。',
						link: 'http://suppresswarnings.com/like.html',
						imgUrl: 'http://suppresswarnings.com/like.png',
						success: function () {
							console.log("===== lijiaming ====");
						}
					});
				});
			},
			error: function(xhr, type){
				alert('js api ticket error!');
				dropload.resetload();
			}
		});
		
	jQuery.getScript("js/payment.js?r=" + Math.random());
}



</script>
</body>
</html>
